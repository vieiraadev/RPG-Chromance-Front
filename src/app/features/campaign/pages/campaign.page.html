<app-navbar></app-navbar>

<div class="campaigns-page campaigns-container">
    <div class="campaigns-page-header">
      <div class="campaigns-header-content">
        <h1 class="campaigns-page-title">
          Minhas Campanhas
        </h1>
        <p class="campaigns-page-subtitle">Construa campanhas lendárias e prove seu valor no campo de batalha</p>
        
        <div class="active-campaign-status" *ngIf="activeCampaignStatus.has_active_campaign">
          <div class="status-card">
            <i class='bx bx-play-circle'></i>
            <div class="status-info">
              <span class="status-text">Campanha Ativa:</span>
              <strong>{{ activeCampaignStatus.active_campaign?.title }}</strong>
              <small>Jogando como {{ activeCampaignStatus.active_campaign?.active_character_name }}</small>
            </div>
            <button class="btn-cancel-global" (click)="cancelActiveCampaign()">
              <i class='bx bx-x'></i>
              Encerrar
            </button>
          </div>
        </div>
      </div>
    </div>
  
    <div *ngIf="isLoading" class="campaigns-loading-container">
      <div class="campaigns-loading-spinner"></div>
      <p>Carregando campanhas...</p>
    </div>

    <div *ngIf="!isLoading" class="campaigns-list-grid">
      
      <div class="campaigns-list-card" 
           *ngFor="let campaign of campaigns; let i = index"
           (click)="openCampaign(campaign.campaign_id)"
           [class.locked]="campaign.is_locked"
           [class.active]="isActiveCampaign(campaign)"
           [class.occupied]="isOccupiedByCampaign(campaign)">
        
        <div class="campaigns-card-image-container">
          <img [src]="campaign.image" [alt]="campaign.title" class="campaigns-card-image">
          <div class="campaigns-card-overlay"></div>
          
          <div *ngIf="campaign.is_locked" class="campaigns-locked-overlay">
            <i class='bx bx-lock-alt'></i>
            <span>Bloqueado</span>
          </div>

          <div *ngIf="isActiveCampaign(campaign)" class="campaigns-active-indicator">
            <i class='bx bx-play-circle'></i>
            <span>Em Progresso</span>
          </div>

          <div *ngIf="isOccupiedByCampaign(campaign)" class="campaigns-occupied-indicator">
            <i class='bx bx-user'></i>
            <span>{{ activeCampaignStatus.active_campaign?.active_character_name }}</span>
          </div>
        </div>
        
        <div class="campaigns-card-content">
          <div class="campaigns-card-header">
            <h3 class="campaigns-card-title">{{ campaign.title }}</h3>
            <p class="campaigns-card-description">
              {{ campaign.description }}
            </p>
          </div>
          
          <div class="campaigns-card-footer">
            <div class="campaigns-card-stats">
              <div class="campaigns-stat-item" [ngSwitch]="campaign.chapter">
                <ng-container *ngSwitchCase="1">
                  <i class='bx bx-brain'></i>
                  <span>Status recomendado: Inteligência 17+</span>
                </ng-container>
                <ng-container *ngSwitchCase="2">
                  <i class='bx bx-run'></i>
                  <span>Status recomendado: Destreza 18+</span>
                </ng-container>
                <ng-container *ngSwitchCase="3">
                  <i class='bx bx-dumbbell'></i>
                  <span>Status recomendado: Força 20+</span>
                </ng-container>
              </div>
              
              <div class="campaigns-stat-item" [ngSwitch]="campaign.chapter">
                <ng-container *ngSwitchCase="1">
                  <i class='bx bx-compass'></i>
                  <span>Estilo: Exploração</span>
                </ng-container>
                <ng-container *ngSwitchCase="2">
                  <i class='bx bx-shield-alt-2'></i>
                  <span>Estilo: Sobrevivência</span>
                </ng-container>
                <ng-container *ngSwitchCase="3">
                  <i class='bx bx-bolt-circle'></i>
                  <span>Estilo: Ação</span>
                </ng-container>
              </div>
            </div>
    
            <div class="campaigns-card-actions">
              
              <ng-container *ngIf="!activeCampaignStatus.has_active_campaign">
                <button class="campaigns-btn-play" 
                        (click)="onCampaignButtonClick(campaign); $event.stopPropagation()"
                        [disabled]="campaign.is_locked">
                  <i class='bx bx-play-circle'></i>
                  Iniciar Campanha
                </button>
              </ng-container>

              <ng-container *ngIf="activeCampaignStatus.has_active_campaign && isActiveCampaign(campaign)">
                <button class="campaigns-btn-continue" 
                        (click)="onCampaignButtonClick(campaign); $event.stopPropagation()">
                  <i class='bx bx-play'></i>
                  Continue
                </button>
                <button class="campaigns-btn-cancel" 
                        (click)="cancelActiveCampaign(); $event.stopPropagation()">
                  <i class='bx bx-stop'></i>
                  Encerrar
                </button>
              </ng-container>

              <ng-container *ngIf="activeCampaignStatus.has_active_campaign && !isActiveCampaign(campaign)">
                <button class="campaigns-btn-occupied" disabled>
                  <i class='bx bx-user'></i>
                  Ocupado
                </button>
              </ng-container>

              <button class="campaigns-btn-info" (click)="$event.stopPropagation()">
                <i class='bx bx-info-circle'></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <div class="campaigns-detail-panel" *ngIf="selectedCampaign" [class.active]="showDetail">
      <button class="campaigns-close-detail" (click)="closeDetail()">
        <i class='bx bx-x'></i>
      </button>
  
      <div class="campaigns-detail-content">
        <div class="campaigns-detail-image">
          <img [src]="selectedCampaign.image" [alt]="selectedCampaign.title">
        </div>
  
        <div class="campaigns-detail-info">
          <h2 class="campaigns-detail-title">{{ selectedCampaign.title }}</h2>
          <p class="campaigns-detail-description">{{ selectedCampaign.full_description }}</p>
  
          <div class="campaigns-detail-rewards">
            <h3>Recompensas disponíveis</h3>
            <div class="campaigns-rewards-grid">
              <div class="campaigns-reward-item" *ngFor="let reward of selectedCampaign.rewards">
                <i [class]="getRewardIconClass(reward.icon)"></i>
                <span>{{ reward.name }}</span>
              </div>
            </div>
          </div>

          <ng-container *ngIf="!activeCampaignStatus.has_active_campaign">
            <button class="campaigns-btn-start" 
                    (click)="startCampaign()"
                    [disabled]="selectedCampaign.is_locked">
              <i class='bx bx-rocket'></i>
              Iniciar Campanha
            </button>
          </ng-container>

          <ng-container *ngIf="activeCampaignStatus.has_active_campaign && isActiveCampaign(selectedCampaign)">
            <div class="detail-actions-group">
              <button class="campaigns-btn-continue-detail" (click)="onCampaignButtonClick(selectedCampaign)">
                <i class='bx bx-play'></i>
                Continue Campanha
              </button>
              <button class="campaigns-btn-cancel-detail" (click)="cancelActiveCampaign()">
                <i class='bx bx-stop'></i>
                Encerrar Campanha
              </button>
            </div>
          </ng-container>

          <ng-container *ngIf="activeCampaignStatus.has_active_campaign && !isActiveCampaign(selectedCampaign)">
            <button class="campaigns-btn-occupied-detail" disabled>
              <i class='bx bx-user'></i>
              Campanha Ocupada por {{ activeCampaignStatus.active_campaign?.active_character_name }}
            </button>
          </ng-container>
        </div>
      </div>
    </div>

    <app-select-character-modal
      [isOpen]="showCharacterModal"
      [campaignTitle]="campaignToStart?.title || ''"
      [campaignId]="campaignToStart?.campaign_id || campaignToStart?.id || ''"
      [campaignChapter]="campaignToStart?.chapter || 1"
      (close)="onCloseCharacterModal()"
      (characterSelected)="onCharacterSelected($event)">
    </app-select-character-modal>
</div>