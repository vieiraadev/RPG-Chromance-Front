<app-navbar></app-navbar>

<div class="game-page game-container">
  <div class="game-content">
    <div class="story-panel">
      <div class="story-header">
        <i class="fas fa-terminal"></i>
        <h3>Interface Neural</h3>

        <button class="btn-clear-log" (click)="clearStoryLog()">
          <i class="bx bx-trash"></i>
        </button>        
      </div>

      <div class="story-content" #storyContent>
        <div 
          *ngFor="let entry of storyLog" 
          class="story-entry"
          [ngClass]="{
            'system-message': entry.type === 'system',
            'narrator-message': entry.type === 'narrator',
            'player-message': entry.type === 'player',
            'llm-message': entry.type === 'llm'
          }">
          
          <span class="timestamp">[{{ entry.timestamp }}]</span>
          
          <span class="message-type">
            <ng-container [ngSwitch]="entry.type">
              <span *ngSwitchCase="'system'">[SISTEMA]</span>
              <span *ngSwitchCase="'narrator'">[NARRADOR]</span>
              <span *ngSwitchCase="'player'">[VOCÊ]</span>
              <span *ngSwitchCase="'llm'">[ MESTRE IA]</span>
            </ng-container>
          </span>
          
          <span class="message">{{ entry.message }}</span>
        </div>

        <div *ngIf="llmLoading" class="story-entry llm-loading">
          <span class="timestamp">[{{ getCurrentTimestamp() }}]</span>
          <span class="message-type">[MESTRE IA]</span>
          <span class="message">
            <div class="llm-typing-indicator">
              <span>Processando</span>
              <div class="dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </span>
        </div>
      </div>
    </div>

    <div class="action-panel">
      <div class="action-header">
        <i class="fas fa-robot"></i>
        <h3>Assistente IA Chromance</h3>
      </div>

      <div class="quick-actions">
        <button class="action-btn" (click)="performAction('examine')">
          <i class="fas fa-search"></i>
          <span>Examinar</span>
        </button>
        <button class="action-btn" (click)="performAction('inventory')">
          <i class="fas fa-backpack"></i>
          <span>Inventário</span>
        </button>
        <button class="action-btn" (click)="performAction('stats')">
          <i class="fas fa-chart-bar"></i>
          <span>Status</span>
        </button>
        <button class="action-btn" (click)="performAction('help')">
          <i class="fas fa-question-circle"></i>
          <span>Ajuda</span>
        </button>
      </div>

      <div class="contextual-actions" *ngIf="availableActions.length > 0">
        <div class="contextual-header">
          <h4>
            <i class="fas fa-magic"></i>
            Ações Contextuais da IA
          </h4>
        </div>
        
        <div class="action-grid">
          <button
            class="context-action-btn"
            *ngFor="let action of getActionsByPriority()"
            (click)="performContextAction(action)"
            [disabled]="llmLoading"
            [style.border-left-color]="getCategoryColor(action.category)"
            [ngClass]="'priority-' + action.priority">
            
            <div class="action-content">
              <span class="action-name">{{ action.name }}</span>
              <small class="action-description">{{ action.description }}</small>
              
              <div class="action-meta">
                <div class="priority-dots">
                  <span 
                    class="priority-dot" 
                    *ngFor="let dot of [].constructor(action.priority); let i = index"
                    [class.active]="i < action.priority">
                  </span>
                </div>
              </div>
            </div>
            
            <div class="action-arrow">
              <i class="bx bx-right-arrow-alt"></i>
            </div>
          </button>
        </div>
        
        <div class="category-summary" *ngIf="availableActions.length > 3">
        </div>
      </div>

      <div class="llm-quick-actions">
        <h4>Ações Rápidas da IA:</h4>
        <div class="llm-action-grid">
          <button
            class="llm-action-btn"
            *ngFor="let suggestion of llmSuggestions"
            (click)="quickLLMAction(suggestion)"
            [disabled]="llmLoading">
            {{ suggestion }}
          </button>
        </div>
      </div>

      <div class="command-input-section">
        <div class="input-header">
          <i class="fas fa-robot"></i>
          <span>Fale com o Mestre IA:</span>
        </div>

        <div class="input-container">
          <input
            type="text"
            class="command-input llm-mode"
            placeholder="Digite sua pergunta ou comando para a IA..."
            [(ngModel)]="customCommand"
            (keyup.enter)="executeCustomCommand()"
            [disabled]="llmLoading"
            #commandInput>
          
          <button 
            class="btn-send llm-mode"
            [disabled]="llmLoading || !customCommand.trim()"
            (click)="executeCustomCommand()">
            <i class='bx bx-send' *ngIf="!llmLoading"></i>
            <i class='bx bx-loader-alt bx-spin' *ngIf="llmLoading"></i>
          </button>
        </div>

        <div class="character-button-section">
          <button class="btn-character" (click)="toggleCharacterPanel()">
            <i class="fas fa-user-astronaut"></i>
            <span>{{ isCharacterPanelCollapsed ? 'Ver Personagem' : 'Ocultar Personagem' }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="character-panel" [class.collapsed]="isCharacterPanelCollapsed">
    <div class="panel-header">
      <h3>
        <i class="fas fa-user-astronaut"></i>
        Perfil Neural
      </h3>
      <button class="btn-toggle" (click)="toggleCharacterPanel()">
        <i class='bx' [ngClass]="{
          'bx-x': !isCharacterPanelCollapsed,
          'bx-chevron-right': isCharacterPanelCollapsed
        }"></i>
      </button>
    </div>

    <div class="panel-content" *ngIf="!isCharacterPanelCollapsed">
      <div class="character-avatar">
        <div class="avatar-container">
          <img [src]="displayCharacterImage" [alt]="displayCharacterName" class="avatar-image">
          <div class="avatar-overlay">
            <i class="fas fa-camera" (click)="changeAvatar()"></i>
          </div>
        </div>
        <div class="character-name">{{ displayCharacterName }}</div>
        <div class="character-level">{{ displayCharacterClass }} - {{ displayCharacterRace }}</div>
        <div class="character-description" *ngIf="displayCharacterDescription && displayCharacterDescription !== 'Personagem padrão'">
          {{ displayCharacterDescription }}
        </div>
        <div class="campaign-info" *ngIf="activeCampaign">
          <small class="campaign-name">{{ activeCampaign.title }}</small>
        </div>
      </div>

      <div class="attributes-section">
        <h4><i class="fas fa-cogs"></i> Atributos</h4>
        <div class="attribute-item" *ngFor="let attr of characterAttributes">
          <span class="attr-name">{{ attr.name }}:</span>
          <div class="attr-bar">
            <div class="attr-fill" [style.width.%]="(attr.value / attr.max) * 100"></div>
          </div>
          <span class="attr-value">{{ attr.value }}/{{ attr.max }}</span>
        </div>
      </div>

      <div class="equipment-section">
        <h4><i class="fas fa-shield-alt"></i> Equipamentos</h4>
        <div class="equipment-grid">
          <div class="equipment-slot" *ngFor="let slot of equipmentSlots">
            <div class="slot-icon">
              <i [class]="slot.icon"></i>
            </div>
            <div class="slot-info" *ngIf="slot.item; else emptySlot">
              <span class="item-name">{{ slot.item.name }}</span>
              <span class="item-quality" [class]="'quality-' + slot.item.quality">{{ slot.item.quality }}</span>
            </div>
            <ng-template #emptySlot>
              <span class="empty-slot">Vazio</span>
            </ng-template>
          </div>
        </div>
      </div>

      <div class="quick-inventory">
        <h4><i class="fas fa-backpack"></i> Inventário Rápido</h4>
        <div class="inventory-grid">
          <div
            class="inventory-item"
            *ngFor="let item of quickInventory"
            (click)="useItem(item)"
            [title]="item.description">
            <i [class]="item.icon"></i>
            <span class="item-count" *ngIf="item.count > 1">{{ item.count }}</span>
          </div>
          <div class="inventory-item empty" *ngFor="let empty of emptySlots"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p>Processando ação...</p>
    </div>
  </div>
</div>